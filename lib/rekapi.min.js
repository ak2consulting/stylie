/**
 * Rekapi - Rewritten Kapi. v0.6.0
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var v=function(h,f){function c(b){return b.sort(function(b,a){return b-a})}function l(b,a){return Math.floor(a/b._animationLength)}function m(b){return e()-b._loopTimestamp}function n(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function k(b,a){n(b,a)&&(b.stop(),j(b,"onAnimationComplete"))}function o(b,a,d){return n(b,d)?b._animationLength:a%b._animationLength}function i(b){var a=m(b),d;d=l(b,a);a=o(b,a,d);b.render(a);k(b,d)}function p(b){b._loopId=setTimeout(function(){p(b);
i(b)},1E3/b.config.fps)}function j(b,a){g.each(b._events[a],function(a){a(b)})}var g=f&&f.underscore?f.underscore:h._,q=f&&f.Tweenable?f.Tweenable:h.Tweenable,a={fps:30,height:150,width:300,doRoundNumbers:!1,clearOnUpdate:!0},e=q.util.now,d=h.Kapi||function(b,d){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],
onPlay:[],onPause:[],onStop:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;g.extend(this.config,d);g.defaults(this.config,a);g.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};d.prototype.addActor=function(b){if(!g.contains(this._actors,b))b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();
return this};d.prototype.getActor=function(b){return this._actors[b]};d.prototype.getActorIds=function(){return g.pluck(this._actors,"id")};d.prototype.getAllActors=function(){return g.clone(this._actors)};d.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=g.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};d.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+
(e()-this._pausedAtTime):e();this._timesToIterate=b||-1;this._playState="playing";p(this);g.each(this._actors,function(b){b._state.isPaused&&b.resume()});j(this,"onPlayStateChange");j(this,"onPlay");return this};d.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=e()-b;return this};d.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};d.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);
this._pausedAtTime=e();g.each(this._actors,function(b){b._state.isTweening&&b.pause()});j(this,"onPlayStateChange");j(this,"onPause");return this};d.prototype.stop=function(b){this._playState="stopped";clearTimeout(this._loopId);!0===b&&this.canvas_clear();g.each(this._actors,function(a){a.stop();!0===b&&a.hide()});j(this,"onPlayStateChange");j(this,"onStop");return this};d.prototype.isPlaying=function(){return"playing"===this._playState};d.prototype.animationLength=function(){return this._animationLength};
d.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};d.prototype.actorCount=function(){return this._drawOrder.length};d.prototype.framerate=function(b){if(b)this.config.fps=b;return this.config.fps};d.prototype.render=function(b){this.calculateActorPositions(b);this.draw();this._lastRenderedMillisecond=b;j(this,"onFrameRender");return this};d.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};d.prototype.calculateActorPositions=
function(b){var a,d,e;e=q.util.isRoundingEnabled();this.config.doRoundNumbers?q.util.enableRounding():q.util.disableRounding();d=this._drawOrder.length;for(a=0;a<d;a++)this._actors[this._drawOrder[a]].calculatePosition(b);!0===e?q.util.enableRounding():q.util.disableRounding();return this};d.prototype.draw=function(){var b,a,d,e,c;this.config.clearOnUpdate&&this.canvas_clear();a=this._drawOrder.length;e=this.canvas_getContext();this._drawOrderSorter?(b=g.sortBy(this._actors,this._drawOrderSorter),
c=g.pluck(b,"id")):c=this._drawOrder;for(b=0;b<a;b++)d=this._actors[c[b]],d.isShowing()&&d.draw(e,d.get());return this};d.prototype.updateInternalState=function(){var b=[];g.each(this._actors,function(a){b.push(a.getEnd())});this._animationLength=Math.max.apply(Math,b);return this};d.prototype.moveActorToLayer=function(b,a){if(a<this._drawOrder.length)return this._drawOrder=g.without(this._drawOrder,b.id),this._drawOrder.splice(a,0,b.id),b};d.prototype.bind=function(b,a){if(this._events[b])return this._events[b].push(a),
this};d.prototype.unbind=function(b,a){if(this._events[b])return this._events[b]=a?g.without(this._events[b],a):[],this};d.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};d.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};d.prototype.exportTimeline=function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};g.each(this._drawOrder,function(d){a.actors[d]=this._actors[d].exportTimeline()},this);return a};
d.util={};g.extend(d.util,{noop:function(){},sortNumerically:c,calculateLoopPosition:o,calculateTimeSinceStart:m});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)d._private={sortNumerically:c,calculateLoopPosition:o,renderCurrentMillisecond:i,tick:p,determineCurrentLoopIteration:l,calculateTimeSinceStart:m,isAnimationComplete:n,updatePlayState:k};h.Rekapi=h.Kapi=d},w=function(h,f){function c(a,e){var d,b,g;g=a._timelinePropertyCacheIndex;b=g.length;for(d=1;d<b;d++)if(g[d]>=e)return d-1;return-1}
function l(a){g.each(a._propertyTracks,function(e,d){a._propertyTracks[d]=g.sortBy(a._propertyTracks[d],function(a){return a.millisecond})})}function m(a){g.each(a._timelinePropertyCaches,function(e,d){var b={};g.each(a._propertyTracks,function(a,e){var c=null;g.find(a,function(a){a.millisecond>d&&(b[e]=c);c=a;return!!b[e]})});g.defaults(e,b)})}function n(a){g.each(a._propertyTracks,function(a){g.each(a,function(d,b){d.linkToNext(a[b+1])})})}function k(a,e,d){return g.find(a._propertyTracks[e],function(a){return a.millisecond===
d})}function o(a,e,d,b){var c=g.keys(a._propertyTracks),f=g.keys(e),c=g.difference(c,f),i={};g.each(c,function(d){var e;e=a._propertyTracks[d].slice(0).reverse();g.each(e,function(a){a.millisecond<b&&!i[d]&&(i[d]={value:a.value,easing:a.easing})})});g.each(i,function(a,b){e[b]=a.value;d[b]=a.easing})}var i,p,j,g=f&&f.underscore?f.underscore:h._,q=f&&f.Tweenable?f.Tweenable:h.Tweenable;i=h.Kapi;p=0;i.Actor=function(a){a=a||{};this.constructor.call(this);g.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},
_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isShowing:!1,_isPersisting:!1,id:p++,setup:a.setup||i.util.noop,draw:a.draw||i.util.noop,teardown:a.teardown||i.util.noop});return this};j=function(){};j.prototype=q.prototype;i.Actor.prototype=new j;i.Actor.prototype.keyframe=function(a,e,d){var b;d||(d="linear");"string"===typeof d&&(b=d,d={},g.each(e,function(a,e){d[e]=b}));g.each(e,function(a,b){d[b]=d[b]||"linear"});o(this,e,d,a);g.each(e,function(b,e){var g;g=new i.KeyframeProperty(this,
a,e,b,d[e]);this._keyframeProperties[g.id]=g;this._propertyTracks[e]||(this._propertyTracks[e]=[]);this._propertyTracks[e].push(g);l(this)},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.getKeyframeProperty=function(a,e){if(this._propertyTracks[a]&&this._propertyTracks[a][e])return this._propertyTracks[a][e]};i.Actor.prototype.modifyKeyframeProperty=function(a,e,d){this._propertyTracks[a]&&this._propertyTracks[a][e]&&this._propertyTracks[a][e].modifyWith(d);
l(this);this.invalidatePropertyCache();return this};i.Actor.prototype.getTrackNames=function(){return g.keys(this._propertyTracks)};i.Actor.prototype.getTrackLength=function(a){return!this._propertyTracks[a]?void 0:this._propertyTracks[a].length};i.Actor.prototype.copyProperties=function(a,e){var d,b;d={};b={};g.each(this._propertyTracks,function(a,g){var c;if(c=k(this,g,e))d[g]=c.value,b[g]=c.easing},this);this.keyframe(a,d,b);return this};i.Actor.prototype.wait=function(a){var e=this.getEnd();if(a<=
e)return this;this.copyProperties(a,e);return this};i.Actor.prototype.getStart=function(){var a=[];g.each(this._propertyTracks,function(e){e.length&&a.push(e[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};i.Actor.prototype.getEnd=function(){var a=0;g.each(this._propertyTracks,function(e){if(e.length)e=g.last(e).millisecond,e>a&&(a=e)},this);return a};i.Actor.prototype.getLength=function(){return this.getEnd()-this.getStart()};i.Actor.prototype.modifyKeyframe=function(a,e,d){d=
d||{};g.each(this._propertyTracks,function(b,g){var c=k(this,g,a);c&&c.modifyWith({value:e[g],easing:d[g]})},this);return this};i.Actor.prototype.removeKeyframe=function(a){g.each(this._propertyTracks,function(e){var d=-1;g.find(e,function(b){d++;return a===b.millisecond});(e=e.splice(d,1)[0])&&delete this._keyframeProperties[e.id]},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.removeAllKeyframeProperties=function(){g.each(this._propertyTracks,
function(a){a.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};i.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};i.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};i.Actor.prototype.hide=function(a){this._isShowing=!1;if(!0===a)this._isPersisting=!1;return this};i.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};i.Actor.prototype.calculatePosition=function(a){var e,d,
b;e=this.getStart();d=this.getEnd();this.hide();e<=a&&a<=d&&(this.show(),e=c(this,a),e=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[e]],b={},g.each(e,function(d,e){b[e]=d.getValueAt(a)}),this.set(b));return this};i.Actor.prototype.data=function(a){if(a)this._data=a;return this._data};i.Actor.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};g.each(this._propertyTracks,function(e,d){var b=a.propertyTracks[d]=
[];g.each(e,function(a){b.push(a.exportPropertyData())})});return a};i.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};g.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=a},this);this._timelinePropertyCacheIndex=g.keys(this._timelinePropertyCaches);g.each(this._timelinePropertyCacheIndex,function(a,e){this._timelinePropertyCacheIndex[e]=
+a},this);i.util.sortNumerically(this._timelinePropertyCacheIndex);m(this);n(this)};g.each(["tween","to"],function(a){i.Actor.prototype[a]=function(){this.show(!0);q.prototype[a].apply(this,arguments)}},this)},x=function(h){function f(c,f,h,n){if("undefined"!==typeof n){c[h]=n;if(!c.style)c.style={};c.style[h]=n+"px"}return f===f.HTML_ELEMENT?c.style[h]:c[h]}h=h.Kapi;h.prototype.canvas_setContext=function(c){var f;this._canvas=c;f=c.nodeName;void 0===f?(this._context={},this._contextType="other"):
"CANVAS"===f?(this._context=c.getContext("2d"),this._contextType="canvas"):(this._context=c,this._contextType="HTMLElement");return this.canvas_getContext()};h.prototype.canvas_getContext=function(){return this._context};h.prototype.canvas_height=function(c){return f(this.canvas,this._contextType,"height",c)};h.prototype.canvas_width=function(c){return f(this.canvas,this._contextType,"width",c)};h.prototype.canvas_style=function(c,f){"undefined"!==typeof f&&this.canvas.style&&(this.canvas.style[c]=
f);return this.canvas.style[c]};h.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}},y=function(h,f){var c,l=f&&f.underscore?f.underscore:h._,m=f&&f.Tweenable?f.Tweenable:h.Tweenable;c=h.Kapi;c.KeyframeProperty=function(c,f,h,i,p){this.id=l.uniqueId("keyframeProperty_");this.ownerActor=c;this.millisecond=f;this.name=h;this.value=i;this.easing=p||"linear";this.nextProperty=null;return this};
c.KeyframeProperty.prototype.modifyWith=function(c){var f={};l.each(["millisecond","easing","value"],function(h){f[h]="undefined"===typeof c[h]?this[h]:c[h]},this);l.extend(this,f)};c.KeyframeProperty.prototype.linkToNext=function(c){this.nextProperty=c||null};c.KeyframeProperty.prototype.getValueAt=function(c){var f,h,i;f={};h={};this.nextProperty?(f[this.name]=this.value,h[this.name]=this.nextProperty.value,i=this.nextProperty.millisecond-this.millisecond,c=(c-this.millisecond)/i,f=m.util.interpolate(f,
h,c,this.nextProperty.easing)[this.name]):f=null;return f};c.KeyframeProperty.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},s=function(h,f){var c=h.Kapi,l=f&&f.underscore?f.underscore:h._,m=["transform","webkitTransform","MozTransform","oTransform","msTransform"];if(h.getComputedStyle)c.DOMActor=function(f){var k;k=new c.Actor({setup:function(){var c=this.kapi.canvas_getContext();"static"===h.getComputedStyle(c).getPropertyValue("position")&&
(this.kapi.canvas_getContext().style.position="relative");"static"===h.getComputedStyle(f).getPropertyValue("position")&&(f.style.position="absolute");this.hide()},draw:function(c,h){var k;k=!1;l.each(h,function(c,g){k=!0;"rotate"===g?l.each(m,function(g){f.style[g]="rotate("+c+"deg)"}):f.style[g]=c});k?this.show():this.hide()}});f.classList.add(k.getCSSName());k.show=function(h){c.Actor.prototype.show.call(this,h);f.style.display="block"};k.hide=function(h){c.Actor.prototype.hide.call(this,h);f.style.display=
"none"};return k},h.Kapi.Actor.prototype.getCSSName=function(){return"actor-"+this.id}},t=function(h,f,c){function l(g){var c=["{"],a;o.each(g.get(),function(e,d){var b;/rgb/.test(e)?b=e:(b=e.match(/\D*$/),b=parseFloat(e).toFixed(2)+b);a=b;c.push(d+":"+a+";")});c.push("}");return c.join("")}function m(g,c,a){var a=a||["w3"],e=[];o.each(a,function(a){a=j(i,[k[a],c,g]);e.push(a)});return e.join("\n")}function n(g,c){var c=c||["w3"],a=[],e;o.each(c,function(d){var b=[],d=k[d],c=g.getStart(),f=g.getEnd()-
c,f=j("  %sanimation-duration: %sms;",[d,f]);b.push(f);f=j("  %sanimation-name: %s;",[d,g.getCSSName()+"-keyframes"]);b.push(f);c=j("  %sanimation-delay: %sms;",[d,c]);b.push(c);d=j("  %sanimation-fill-mode: forwards;",[d]);b.push(d);e=b.join("\n");a.push(e)});return j(p,[g.getCSSName(),a.join("\n")])}var k=h.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},o=c&&c.underscore?c.underscore:f._,i="@%skeyframes %s-keyframes {\n%s\n}",p=".%s {\n  position: absolute;\n%s\n}";
f.Kapi.prototype.toCSS=function(c){var c=c||{},f=[],a=this.getActorIds();o.each(a,function(a){f.push(this.getActor(a).toCSS(c))},this);return f.join("\n")};f.Kapi.Actor.prototype.toCSS=function(c){var c=c||{},f=[],a=c.granularity||100,e=n(this,c.vendors);f.push(e);for(var e=this.getLength(),d=this.getStart(),b=[],h,i=e/a,j=e/100,a=d;a<=e+d;a+=i)this.calculatePosition(a),h=(a-d)/j,h=0===h?"from ":100===h?"to ":h.toFixed(2)+"% ",b.push("  "+h+l(this));e=b.join("\n");c=m(e,this.getCSSName(),c.vendors);
f.push(c);return f.join("\n")};var j=h.util.printf=function(c,f){var a=c;o.each(f,function(c){a=a.replace("%s",c)});return a}},u=function(h,f){var c=f?{}:h;v(c,f);w(c,f);x(c,f);y(c,f);"function"===typeof s&&s(c,f);"function"===typeof t&&t(c.Kapi,c,f);return c.Kapi};if("function"===typeof define&&define.amd){var z="undefined"!==typeof _;define(["shifty","underscore"],function(h,f){var c={Tweenable:h,underscore:null!==f?f:_},l=u(r,c);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)l.underscore_version=
c.underscore.VERSION;z||delete r._;return l})}else u("undefined"!==typeof r?r:this)})(this);
